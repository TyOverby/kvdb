open! Core
open Common
module Table = Int_to_string_star_string

let%expect_test "empty table" =
  let t = Table.create ~path:"foo" in
  print_endline (Table.to_string_for_testing t);
  [%expect
    {|
    ┌─────┬──────┬─────────────┬──────────────┐
    │ key │ data │ key (bytes) │ data (bytes) │
    ├┬┬┬┬┬┼┬┬┬┬┬┬┼┬┬┬┬┬┬┬┬┬┬┬┬┬┼┬┬┬┬┬┬┬┬┬┬┬┬┬┬┤
    └┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┘
    |}]
;;

let%expect_test "single put" =
  let t = Table.create ~path:"foo" in
  Table.put t ~key:0 ~data:("hi", "there");
  print_endline (Table.to_string_for_testing t);
  [%expect
    {|
    ┌─────┬─────────────┬────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐
    │ key │ data        │ key (bytes)                                                            │ data (bytes)                                                                   │
    ├─────┼─────────────┼────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤
    │ 0   │ (hi, there) │ 00000000  00 00 00 00 00 00 00 00                           |........| │ 00000000  00 00 00 00 00 00 00 02  68 69 00 00 00 00 00 00  |........hi......| │
    │     │             │                                                                        │ 00000010  00 00 05 74 68 65 72 65                           |...there|         │
    └─────┴─────────────┴────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "multi put" =
  let t = Table.create ~path:"foo" in
  Table.put t ~key:0 ~data:("hello", "foo");
  Table.put t ~key:1 ~data:("world", "bar");
  print_endline (Table.to_string_for_testing t);
  [%expect
    {|
    ┌─────┬──────────────┬────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐
    │ key │ data         │ key (bytes)                                                            │ data (bytes)                                                                   │
    ├─────┼──────────────┼────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤
    │ 0   │ (hello, foo) │ 00000000  00 00 00 00 00 00 00 00                           |........| │ 00000000  00 00 00 00 00 00 00 05  68 65 6c 6c 6f 00 00 00  |........hello...| │
    │     │              │                                                                        │ 00000010  00 00 00 00 00 03 66 6f  6f                       |......foo|        │
    │ 1   │ (world, bar) │ 00000000  00 00 00 00 00 00 00 01                           |........| │ 00000000  00 00 00 00 00 00 00 05  77 6f 72 6c 64 00 00 00  |........world...| │
    │     │              │                                                                        │ 00000010  00 00 00 00 00 03 62 61  72                       |......bar|        │
    └─────┴──────────────┴────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "put and then delete" =
  let t = Table.create ~path:"foo" in
  Table.put t ~key:0 ~data:("hello", "foo");
  Table.put t ~key:1 ~data:("world", "bar");
  print_endline (Table.to_string_for_testing t);
  [%expect
    {|
    ┌─────┬──────────────┬────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐
    │ key │ data         │ key (bytes)                                                            │ data (bytes)                                                                   │
    ├─────┼──────────────┼────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤
    │ 0   │ (hello, foo) │ 00000000  00 00 00 00 00 00 00 00                           |........| │ 00000000  00 00 00 00 00 00 00 05  68 65 6c 6c 6f 00 00 00  |........hello...| │
    │     │              │                                                                        │ 00000010  00 00 00 00 00 03 66 6f  6f                       |......foo|        │
    │ 1   │ (world, bar) │ 00000000  00 00 00 00 00 00 00 01                           |........| │ 00000000  00 00 00 00 00 00 00 05  77 6f 72 6c 64 00 00 00  |........world...| │
    │     │              │                                                                        │ 00000010  00 00 00 00 00 03 62 61  72                       |......bar|        │
    └─────┴──────────────┴────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘ |}];
  Table.delete t 0;
  print_endline (Table.to_string_for_testing t);
  [%expect
    {|
    ┌─────┬──────────────┬────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐
    │ key │ data         │ key (bytes)                                                            │ data (bytes)                                                                   │
    ├─────┼──────────────┼────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤
    │ 1   │ (world, bar) │ 00000000  00 00 00 00 00 00 00 01                           |........| │ 00000000  00 00 00 00 00 00 00 05  77 6f 72 6c 64 00 00 00  |........world...| │
    │     │              │                                                                        │ 00000010  00 00 00 00 00 03 62 61  72                       |......bar|        │
    └─────┴──────────────┴────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
